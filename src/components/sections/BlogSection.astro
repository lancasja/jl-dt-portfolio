---
import { getCollection } from "astro:content";
import BlogCard from "@/components/cards/BlogCard.astro";
import SectionHeader from "@/components/elements/SectionHeader.astro";
import AnimatedText from "@/components/ui/AnimatedText.astro";
import Button from "@/components/ui/Button.astro";
import Pagination from "@/components/widgets/Pagination.astro";
// Component props
const {
	title = "Latest Articles",
	description = "",
	limit = 3,
	listPage = false,
	showViewAllButton = true,
	pagination = {
		enable: false,
		currentPage: 1,
	},
	postsPerPage = 3,
} = Astro.props;

// Get blog post collection
const allPosts = await getCollection("post");

// Sort by publish date
let posts = allPosts.sort(
	(a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

// Find featured post
const featuredPost = posts.find((post) => post.data.featured);

// If featured exists, remove it from main list
if (featuredPost && listPage) {
	posts = posts.filter((post) => post.data.featured !== true);
}

// Calculate total pages
const totalPages = Math.ceil(posts.length / postsPerPage);

// If pagination enabled, show only current page posts
if (pagination.enable) {
	const indexOfLastPost = pagination.currentPage * postsPerPage;
	const indexOfFirstPost = indexOfLastPost - postsPerPage;
	posts = posts.slice(indexOfFirstPost, indexOfLastPost);
} else if (!listPage) {
	// If not list page, limit post count
	posts = posts.slice(0, limit);
}

// Add link to each post - create new objects
const postsWithLinks = posts.map((post) => {
	// Per Astro v5 docs, entry.id is the unique identifier
	// Use entry.id for URL; for [...slug] route, id is already the path
	const link = `/blog/${post.id}`;
	return {
		...post,
		data: {
			...post.data,
			link,
		},
	};
});

// Create linked version of featured post
const featuredPostWithLink = featuredPost
	? {
			...featuredPost,
			data: {
				...featuredPost.data,
				link: `/blog/${featuredPost.id}`,
			},
		}
	: null;
---

{/* Featured post section - only on list page first page */}
{listPage && featuredPostWithLink && pagination.currentPage === 1 && (
  <section class="mb-16">
    <div class="site-container">
      <h2 class="text-3xl font-brand mb-6 text-neutral-800 dark:text-white">
            <AnimatedText delay={0.75} stagger={0.08} content="Featured" />
      </h2>
      <div class=" dark:from-neutral-900 dark:to-neutral-800 p-1 rounded-2xl ">
        <BlogCard
          layout="horizontal"
          content={{ ...featuredPostWithLink.data, ...featuredPostWithLink }}
          data-aos="fade-up-sm"
          data-aos-delay="1000"
        />
      </div>
    </div>
  </section>
)}

<section>
  <div class="site-container space-y-10 md:space-y-16">
    {!listPage && title && (
      <SectionHeader title={title}  description={description}/>
    )}

    {/* List page title */}
    {listPage && title && (
      <div class="mx-auto">
        <h2 class="text-3xl font-brand text-neutral-800 dark:text-white">{title}</h2>
      </div>
    )}

    <div class="grid gap-x-6 gap-y-10 md:grid-cols-2 xl:grid-cols-3">
      {postsWithLinks && postsWithLinks.map((post, index) => (
        <BlogCard
          content={{ ...post.data, ...post }}
          data-aos={!pagination.enable && (Math.floor(index / 3) % 2 === 0 ? "fade-right-sm" : "fade-left-sm")}
          data-aos-delay={!pagination.enable && ((index % 3) + 1) * 200}
        />
      ))}
    </div>

    {listPage && totalPages > 1 && (
      <Pagination
        collection="blog"
        currentPage={pagination.currentPage || 1}
        totalPages={totalPages}
      />
    )}
  </div>

  {/* "View All Articles" button - only when not list page and enabled */}
  {!listPage && showViewAllButton && (
    <div class="flex justify-center mt-12 mb-12">
      <Button url="/blog" className="w-full max-w-60">View All Articles</Button>
    </div>
  )}
</section>